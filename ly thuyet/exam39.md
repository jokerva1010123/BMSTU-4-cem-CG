# 39. Определение нормали к поверхности и вектора отражения (4 способа) в алгоритмах построения реалистических изображений.

## Определение нормали к поверхности

**1.** Если известно аналитическое описание поверхности - нормаль вычисляется через градиент в точке.  
```grad(F(x, y, z))```

**2.** Если заданы уравнения плоскостей, проходящие через полигональные грани, то нормаль к их общей вершине равна среднему значению нормалей ко всем многоугольникам, сходящимся в этой вершине.  
```N = (A1 + ... + An)i + (B1 + ... + Bn)j + (C1 + ... + Cn)k```

* An - коэффициенты уравнений плоскостей.

**3.** Если не заданы уравнения плоскостей. В таком случае, нормаль ищется путём усредненяя векторного произведения векторов, построенных на всех ребрах, пересекающихся в вершине.  
```N = v1v2 + v2v3 + v3v1```

* v1 - v3 векторы ребер инцидентных вершине в которой ищется нормаль.

Требуется найти только внешние нормали. 

Если нормаль к поверхности **используется для определения интенсивности** и **для изображения объекта** или **сцены выполняется перспективное преобразование**, то нормаль следует вычислять до перспективного преобразования. Иначе направление нормали будет искажено, что приведет к неправильному определению интенсивности, задаваемой моделью освещения.

## Определение вектора отражения.

**Основная идея:** по закону отражения вектор падающего света, нормаль к поверхности и вектор отражения лежат в одной плоскости, причем на этой плоскости угол падения равен углу отражения. 

Существует **диффузное** и **зеркальное** отражение.  
При диффузном: свет поглащается поверхностью на которую падает и вновь излучается этой поверхностью по всем направлениям. Цвет совпадает с цветом поверхности.

При зеркальном: цвет концентрируется вокруг вектора отражения, то есть это направленное отражение. Цвет зеркального отраженного света совпадает с цветом падающего света.

**Отражение происходит не строго по вектору**, а вблизи. Его можно получить возведением косинуса в степень. Чем выше степень, тем более концентрированное распределение. 

### Первый способ

Это решение подходит для случая, когда свет падает вдоль оси Z. Удобно использовать для модели освещения с одним точечным источником. Переносят начало СК в точку поверхности, проекция вектора нормали и отражения (на плоскость ху) будут лежать на одной прямой. 

![1](https://camo.githubusercontent.com/f40ce2f36441b661e6b7b51a07728c22cf6bfaaf/68747470733a2f2f73756e312d38362e757365726170692e636f6d2f756539776d5a2d542d544f79776d524a664631495a686e576746704e376b2d546c376b7570672f43595f595152684f4d38492e6a7067)

* Угол между единичным вектором нормали и осью Z - θ.  
* cos(θ) - составляющая вектора нормали по оси z. 

![2](https://camo.githubusercontent.com/ee1cd3d8bd49d70eb5a79f04c99fdd3d306e11d1/68747470733a2f2f73756e312d32322e757365726170692e636f6d2f5f75646f5965466b38344547792d34467a444c52594a30426738594a492d46366e64544e38512f48543153593131754646732e6a7067)

Итоговые формулы:

![3](https://camo.githubusercontent.com/6f736b74010a652ab90b7192cf7ba160088d71ed/68747470733a2f2f73756e312d32342e757365726170692e636f6d2f37694234455a6f6a755a48665f53785536704e4b557743337a4f4761396e724c5a4a334d48772f384a52377a796c443273302e6a7067)

### Второй способ

Использовать можно когда не подходит первый метод (свет не падает по оси z или источников несколько).

Нормаль поворачивается параллельно оси Z, точка P - начало координат. В таком случае, плоскость xy - касательная к поверхности, х и у составляющие векторов падения и отражения будут иметь разные знаки, z составляющая - одинаковая. Далее: обратное преобразование и получение координат вектора отражения в исходной СК.

В перемещенной и повернутной CК:  
![5](https://sun9-35.userapi.com/c857528/v857528123/20edea/bgCnf0IbNOk.jpg)

Метод удобен, когда преобразования реализованы аппаратно или микропрограммно. 

### Третий способ

Основано на векторном произведении. Равенство углов падения и отражения выражается через скалярные произведения произведения векторов:

![](https://camo.githubusercontent.com/4df70d120d99cb8d4ac4c25b9c41fa2bc39167c8/68747470733a2f2f73756e312d31392e757365726170692e636f6d2f56525268553439506f425f69714f4d53793833563472694c76625630347564473547686730672f3643484733704d5844526b2e6a7067)

![6](https://camo.githubusercontent.com/8c5a01a0aadd5fee9e594ebbefa1834c2ace50c2/68747470733a2f2f73756e312d32352e757365726170692e636f6d2f7653736a71526558456965427777795353435572794c446c41724f6c53356f5a3346547646412f48424359696c786d3041592e6a7067)


### Четвертый способ

ЧИСТО **АНАЛ**ИТИЧЕСКИЙ СПОСОБ!

![7](https://camo.githubusercontent.com/a61847bfe4da0fadf7fe0c03a5fb9c2fedbab77f/68747470733a2f2f73756e312d32332e757365726170692e636f6d2f343042617942326c634d57394b36774232347731344253424c5352365f662d6b7935586461412f30666850445430597a30382e6a7067)

* t - угол падения
* Вектор R представляется суммой векторов L и n с некоторыми коэфами альфа и бета 
* Решается сис-ма из двух уравнений и находятся эти коэфы.

Ну а дальше дело техники: домножаем на один кеф вектор нормали, на другой - вектор падения и получаем вектор отражения!

**Следующий вопрос:**  [40. Построение теней при создании реалистических изображений. Учет теней в алгоритмах удаления невидимых поверхностей.](./exam40)


**Предыдущий вопрос:**  [38. Построение реалистических изображений. Закраска Фонга  (улучшение аппроксимации кривизны поверхности).](./exam38)
