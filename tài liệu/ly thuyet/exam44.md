# 44. Алгоритм трассировки лучей с использованием глобальной модели  освещения.

Модель освещения предназначена для расчёта интенсивности отражённого к наблюдателю света в каждой точке изображения. Модель может быть глобальной или локальной.

* **Локальная модель** - учитывается только свет от источников и ориентация поверхности;
* **Глобальная модель** - учитывается ещё и свет, отражённый от других поверхностей или пропущенный через них.

![](https://camo.githubusercontent.com/991ade966783fcc87a18e01971388f45b9b1c21d/68747470733a2f2f63646e2e646973636f72646170702e636f6d2f6174746163686d656e74732f3439343535313837343930393839363730342f3731393530393234393536363137393337382f756e6b6e6f776e2e706e67)

На рисунке сфера, треугольная призма и параллелепипед непрозрачны. Их поверхность зеркальна.

Если наблюдатель смотрит из точки обзора **0** в точку **1**, то он также видит точку **2** на призме, несмотря на то, что призма загорожена параллелепипедом. В этом случае изображение, получаемое вокруг точки **1**, перевёрнуто в силу того, что оно получается после одного отражения.

Если же наблюдатель смотрит в точку **1'**, то он видит не только точку **3'** на призме, но и точку **2'** на параллелепипеде. При этом точка **3'** видима после одного отражения от сферы, в силу чего на сфере будет видно два изображения призмы. Второе изображение будет менее интенсивно. Более того, в сфере отражается обратная сторона параллелепипеда. Несмотря на то, что она освещается лишь отражённым светом, она всё равно видима наблюдателю.

Глобальная модель освещения является частью алгоритмов выделения видимых поверхностей путём трассировки лучей.

## Метод Потметсила

Метод Потметсила состоит из двух шагов:
* Построение изображения;
* Постпроцессинг;

Во время первого этапа с помощью метода трассировки строится "простое" изображение по выборочным точкам (т.е. изображение для камеры с маленьким отверстием). Для каждого пиксела хранятся данные о глубине **z**, интенсивности RGB и видимых поверхностях.

Во время второго шага каждая точка преобразуется в круг согласно законам геометрической оптики. Распределения размеров интенсивностей зависят от значения **z**.

Уиттед использует те же модели рассеянного, диффузного и зеркального отражения Фонга, что и локальная модель.

## Глобальное зеркальное отражение

![](https://camo.githubusercontent.com/58c6b5dc09759a1a0b7dbf5dd01a8cbec05b64cc/68747470733a2f2f6d656469612e646973636f72646170702e6e65742f6174746163686d656e74732f3439343535313837343930393839363730342f3731393536383534373331393338323033362f756e6b6e6f776e2e706e67)

Компоненты, соответствующие глобальному зеркальному отражению, рассчитываются по правилу, описанному ниже:

Пускай трассируется луч **v**, падающий на поверхность в точку **Q**. В этой точке он отражается в направлении **r**, и, если поверхность прозрачна, преломляется в направлении **p**. Здесь **I<sub>t</sub>** - интенсивность света в направлении **p**. Этот свет преломляется и достигает наблюдателя в направлении **v**.

Аналогично, **I<sub>s</sub>** - интенсивность зеркально отражённого света, падающего в направлении **r** и отражённая наблюдателю в точку **Q**. **n** - нормаль к поверхности в точке **Q**. **L<sub>j</sub>** - направление на **j**-й источник света. **S, R** - локальные векторы наблюдения и отражения. **η** - показатель преломления среды, **m** - степень пространственного распределения Фонга для зеркального отражения.

Наблюдаемая интенсивность выражается формулой:

![](https://camo.githubusercontent.com/298510c0daac64d87fb94bf47c21722a6bb52d77/68747470733a2f2f6d656469612e646973636f72646170702e6e65742f6174746163686d656e74732f3439343535313837343930393839363730342f3731393537313133343731343038353337372f756e6b6e6f776e2e706e67)

Здесь **k<sub>a</sub>, k<sub>d</sub>, k<sub>s</sub>** - коэффициенты рассеянного, диффузного и зеркального отражений, а **k<sub>t</sub>** - коэффициент пропускания.

## Дерево лучей

В глобальной модели освещения предполагается, что падающий луч **v** в точке **Q** отражается в направлении **r** и проходит сквозь поверхность в направлении **p**. Таким образом, в точке образуется ещё два луча. для которых нужно найти все пересечения с объектами. Процесс повторяется до тех пор, пока не останется ни одного пересечения.

![](https://camo.githubusercontent.com/0ea4d5c2903463692e3b3020bb89fbe8238002fa/68747470733a2f2f6d656469612e646973636f72646170702e6e65742f6174746163686d656e74732f3439343535313837343930393839363730342f3731393538323432303639323633313536322f756e6b6e6f776e2e706e67)

Пусть **v** - падающий луч, **r** - отражённый, а **p** - преломлённый. Пропущенный луч высчитывается по **закону Снеллиуса**: 

![](https://camo.githubusercontent.com/f12a89e12b775e2e0de4cb56758c2467268b43da/68747470733a2f2f6d656469612e646973636f72646170702e6e65742f6174746163686d656e74732f3439343535313837343930393839363730342f3731393537373034383238303037323237322f756e6b6e6f776e2e706e67)

Здесь **k<sub>n</sub>** - отношение показателей преломления, **n** - вектор единичной нормали в направлении падающего луча.

По итогу, для расчёта результирующей интенсивности луча нужно обойти дерево в обратном направлении, учитывая ослабление луча при каждом отражении.

В теории, глубина дерева может быть любой, но его построение можно прерывать при достижении определённого уровня или при исчерпании запаса памяти.

## Обработка теней

Если мы хотим включить в алгоритм обработку теней, то нужно из каждого пересечения луча с поверхностью направить ко всем источникам **L<sub>j</sub>** теневые зонды.

Если на направлении между точкой и источником света лежит другой объект, то точка относительно этого источника лежит в тени и его вклад в локальное и диффузное отражение этого источника уменьшается.

Если поверхность, лежащая на пути луча, непрозрачна, то свет вообще не попадает на поверхность.

Если тень отбрасывается прозрачной поверхностью, то свет ослабляется в зависимости от её свойств.

Теневые зонды:

![]( https://camo.githubusercontent.com/1dd3e7dd115e3ebbbe1dd812af66ff38dd32966e/68747470733a2f2f63646e2e646973636f72646170702e636f6d2f6174746163686d656e74732f3439343535313837343930393839363730342f3731393538323332373335363738343635302f756e6b6e6f776e2e706e67)

## Реализация

Для передачи данных об отражённом и пропущенном свете применяется стек магазинного типа. Стек содержит в себе в каждый момент только часть дерева (как вариант, самую длинную предполагаемую ветвь). При переполнении стека алгоритм рассчитывает интенсивность исходного луча, используя имеющиеся компоненты в точке падения.

Содержание стека для каждого луча:
* Идентификатор луча;
* Тип луча (**v** - из глаза, **r** - отражённый, **p** - преломлённый);
* Идентификатор исходного луча;
* Тип исходного луча;
* Флаг пересечения (1, если есть пересечения, 0 - иначе);
* Указатель объекта (положение объекта, с которым луч пересекается);
* Координаты пересечения;
* Направляющие косинусы луча;
* d (расстояние от пересечения исходного до пересечения данного лучей);
* I<sub>t</sub> (интенсивность пропущенного света в направлении луча);
* I<sub>s</sub> (интенсивность зеркально отражённого света в направлении луча).

## Блок-схемы

* Модель освещения для алгоритма трассировки луча с использованием глобальной модели освещения

![](https://camo.githubusercontent.com/54b00de50b51b4778571384361d8a926b0fea0bb/68747470733a2f2f6d656469612e646973636f72646170702e6e65742f6174746163686d656e74732f3439343535313837343930393839363730342f3731393538353932373734373630303430342f756e6b6e6f776e2e706e67)

* Глобальная модель освещения с трассировкой лучей

![](https://camo.githubusercontent.com/fb12a47970b91c8034d5187f6c490e6ff1496f28/68747470733a2f2f6d656469612e646973636f72646170702e6e65742f6174746163686d656e74732f3439343535313837343930393839363730342f3731393538363631313633363939343132382f756e6b6e6f776e2e706e67)

![](https://camo.githubusercontent.com/31b76edabd0d58055969f81fefd6351410de19ec/68747470733a2f2f6d656469612e646973636f72646170702e6e65742f6174746163686d656e74732f3439343535313837343930393839363730342f3731393538363739383430353238383030372f756e6b6e6f776e2e706e67)

**Следующий вопрос:**  [45. Определение направления  преломленного луча.](./exam45)


**Предыдущий вопрос:**  [43. Глобальная модель освещения с трассировкой лучей.](./exam43)
